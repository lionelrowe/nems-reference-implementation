<template>

    <section class="container">
        <h1 class="h1">${heading}</h1>

        <form>
            <div class="form-group">
                <label for="subscriberSelect">Select a Subscriber</label>

                <div class="row">
                    <div class="col-xs-12">
                        <spinner-msg message="Loading Subscribers" logic.one-way="loadingSubscribers"></spinner-msg>
                        <select value.bind="selectedSubscriber" class="form-control" id="subscriberSelect" show.bind="!loadingSubscribers">
                            <option model.bind="null">--select--</option>
                            <option repeat.for="sub of subscribers" model.bind="sub" selected>${sub.odsCode}</option>
                        </select>
                    </div>
                </div>

            </div>
        </form>

        <div show.bind="selectedSubscriber">
            <ul class="nav nav-tabs well-tabs" role="tablist" id="subscriberTabs">
                <li role="presentation" class="active"><a href="#mySubscriptions" aria-controls="mySubscriptions" role="tab" data-toggle="tab">My Subscriptions</a></li>
                <li role="presentation">
                    <a href="#eventsMailbox" aria-controls="profile" role="tab" data-toggle="tab">
                        Events Mailbox (${selectedSubscriber.meshMailboxId})
                        <i class="fa fa-envelope" aria-hidden="true" show.bind="promptMailbox && subscriberLayout.subscriptionViewActive"></i>
                        <i class="fa fa-circle-o-notch fa-pulse" aria-hidden="true" show.bind="promptMailbox && !subscriberLayout.subscriptionViewActive"></i>
                    </a>
                </li>
                <li class="pull-right">
                    <button class="btn btn-primary" click.delegate="showNewSubscription()" show.bind="subscriberLayout.subscriptionViewActive">Create Subscription</button>
                </li>
            </ul>


            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="mySubscriptions">

                    <div class="well bg-default">
                        <spinner-msg message="Checking Subscriptions" logic.one-way="subscriberLayout.loading"></spinner-msg>

                           <div class="row">
                            <div class.bind="subscriberLayout.subscriptionsListClass">

                                <p show.bind="selectedSubscriber && (!subscriptions || subscriptions.length === 0)">No Subscriptions found for ${selectedSubscriber.odsCode}</p>

                                <table class="table table-striped" show.bind="selectedSubscriber && subscriptions && subscriptions.length > 0">
                                    <thead>
                                        <tr>
                                            <th class="sub-id">ID</th>
                                            <th class="sub-criteria">Criteria</th>
                                            <th class="sub-status">Status</th>
                                            <th class="sub-endpoint">Endpoint</th>
                                            <th class="sub-action">&nbsp;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr repeat.for="sub of subscriptions" class.bind="subscriberLayout.activeSubscriptionClass[sub.id]">
                                            <td class="sub-id">${sub.id}</td>
                                            <td class="sub-criteria">${sub.criteria}</td>
                                            <td class="sub-status">${sub.status}</td>
                                            <td class="sub-endpoint">${sub.channel.endpoint}</td>
                                            <td class="sub-action">
                                                <i class="fa fa-caret-right"></i>
                                                <button class="btn btn-default sub-view" click.delegate="showSubscription(sub)">View Subscription</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-xs-8" show.bind="subscriberLayout.showSubscription">
                                <div class="container-fluid">
                                    <h3>
                                        <span show.bind="subscriberLayout.creating">New Subscription</span>
                                        <span show.bind="!subscriberLayout.creating">Subscription Details</span> 
                                        <button click.delegate="hideSubscription()" class="btn btn-warning pull-right">Hide Subscription</button>
                                    </h3>

                                    <form>
                                        <div class="form-group">
                                            <label for="messageFormat">Message Format</label>
                                            <select value.bind="selectedExampleMessageFormat" class="form-control" id="messageFormat">
                                                <option repeat.for="exampleMessageFormat of exampleMessageFormats" model.bind="exampleMessageFormat">${exampleMessageFormat.value}</option>
                                            </select>
                                        </div>

                                        <b>Body Preview</b>
                                        <pre class="examples">${exampleMessageBody}</pre>

                                        <h4 show.bind="!subscriberLayout.creating">Delete Request</h4>
                                        <h4 show.bind="subscriberLayout.creating">Create Request</h4>

                                        <div class="form-group">
                                            <label for="Endpoint">Request</label>
                                            <div class="well well-content-break">
                                                <b>Endpoint</b>
                                                <pre>${subscribeRequest.method | uppercase} ${subscribeRequest.endPoint}</pre>

                                                <b>Headers</b>
                                                <pre>
fromASID: ${subscribeRequest.fromAsid}
toASID: ${subscribeRequest.toAsid}
InteractionID: ${subscribeRequest.interactionId}
Content-Type: ${subscribeRequest.contentType}
Authorization: Bearer ${subscribeRequest.jwt}
</pre>
                                            </div>
                                        </div>

                                        <div class="form-group" show.bind="!subscribeRequest.running && response">
                                            <label for="Endpoint">Response</label>
                                            <div class="well well-content-break">
                                                <b>Status</b>
                                                <pre>${response.statusCode} ${response.statusText}</pre>

                                                <b>Headers</b>
<pre><span repeat.for="key of response.headers | keys">${key}: ${response.headers[key]}
</span></pre>

                                                <b>Body<span show.bind="response.body.length === 0"> (<span class="text-warning">no body returned</span>)</span></b>
                                                <pre class="examples" show.bind="response.body.length > 0">${response.body}</pre>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-xs-4">
                                                <button type="submit" disabled.bind="!response && subscribeRequest.running" click.trigger="send()" class="btn ${subscriberLayout.creating ? 'btn-success' : 'btn-danger'}">
                                                    ${subscriberLayout.creating ? "Create " + (response ? "another ": "") : "Delete " }Subscription
                                                </button>
                                            </div>
                                            <div class="col-xs-4">
                                                <spinner-msg message="Sending Request" logic.one-way="!response && subscribeRequest.running"></spinner-msg>
                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Tab 1 end -->
                </div>
                <div role="tabpanel" class="tab-pane" id="eventsMailbox">
                    <div class="well bg-default">

                        <div class="row">

                            <div class.bind="eventLayout.eventListClass">
                                <p show.bind="selectedSubscriber && (!mailboxEntries || mailboxEntries.length === 0)">No messages found for ${selectedSubscriber.meshMailboxId}</p>

                                <table class="table table-striped" show.bind="selectedSubscriber && mailboxEntries && mailboxEntries.length > 0">
                                    <thead>
                                        <tr>
                                            <th class="sub-id">Message ID</th>
                                            <th class="sub-status">Event Type</th>
                                            <th class="sub-criteria">Message Preview</th>
                                            <th class="sub-action">&nbsp;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr repeat.for="entry of mailboxEntries"  class.bind="eventLayout.activeEventClass[entry.messageId]">
                                            <td class="sub-id">${entry.messageId}</td>
                                            <td class="sub-status">${entry.type}</td>
                                            <td class="sub-criteria">${entry.message | substr:0:80}</td>
                                            <td class="sub-action">
                                                <i class="fa fa-caret-right"></i>
                                                <div class="btn-group sub-view" role="group">
                                                    <button class="btn btn-primary" click.delegate="showEvent(entry)">View</button>
                                                    <button class="btn btn-danger" click.delegate="removeEvent(entry.messageId)"><i class="fa fa-trash-o"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="col-xs-8" show.bind="eventLayout.showEvent">
                                <div class="container-fluid">
                                    <h3>Event Details <button click.delegate="hideEvent()" class="btn btn-warning pull-right">Hide Event</button></h3>

                                    <div class="form-group">
                                        <label for="messageFormat">Message ID</label>
                                        <input type="text" class="form-control" name="eventMessageId" value.bind="eventLayout.activeEvent.messageId" readonly />
                                    </div>

                                    <div class="form-group">
                                        <label for="messageFormat">Event Type</label>
                                        <input type="text" class="form-control" name="eventType" value.bind="eventLayout.activeEvent.type" readonly />
                                    </div>

                                    <label for="Endpoint">Event Message Body</label>
                                    <div class="well well-content-break">
                                        <pre class="examples">${eventLayout.activeEvent.message}</pre>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>  

    </section>
</template>
